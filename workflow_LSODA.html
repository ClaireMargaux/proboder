<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Claire Descombes" />

<meta name="date" content="2024-07-05" />

<title>Workflow ProbODER LSODA</title>

<script src="workflow_LSODA_files/header-attrs-2.26/header-attrs.js"></script>
<script src="workflow_LSODA_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="workflow_LSODA_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="workflow_LSODA_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="workflow_LSODA_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="workflow_LSODA_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="workflow_LSODA_files/navigation-1.1/tabsets.js"></script>
<link href="workflow_LSODA_files/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="workflow_LSODA_files/highlightjs-9.12.0/highlight.js"></script>
<script src="workflow_LSODA_files/kePrint-0.0.1/kePrint.js"></script>
<link href="workflow_LSODA_files/lightable-0.0.1/lightable.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div id="header">



<h1 class="title toc-ignore">Workflow ProbODER LSODA</h1>
<h4 class="author">Claire Descombes</h4>
<h4 class="date">2024-07-05</h4>

</div>


<div id="simulation-a" class="section level2">
<h2>Simulation A</h2>
<div id="simulate-data" class="section level4">
<h4>Simulate data</h4>
<pre class="r"><code># --------------
# Initialization
# --------------

model &lt;- &#39;SEIR&#39; # model to be simulated (&#39;SEIRD&#39; or &#39;SEIR&#39; available)

steps &lt;- 1 # steps for time grid
max_time &lt;- 30 # max time for time grid

lambda &lt;- 1/(2.6) # latency rate, ref value 1/(2.6)
gamma &lt;- 1/(2.6) # recovery rate, ref value 1/(2.6)
if (model == &#39;SEIRD&#39;) {
  eta &lt;- 0.024*(1/15) # fatality rate, ref value 0.024*(1/15)
} else if (model == &#39;SEIR&#39;) {
  eta &lt;- 0
}

beta &lt;- function(t){2*cos(t/30)-1} # funtion for contact rate

# Starting compartment counts
if (model == &#39;SEIRD&#39;) {
  xstart &lt;- c(S = 499980, E = 5, I = 5, R = 5, D = 0)
} else if (model == &#39;SEIR&#39;) {
  xstart &lt;- c(S = 499985, E = 5, I = 5, R = 5)
}
pop &lt;- sum(xstart)

noise &lt;- 10 # noise to add on the data, set &gt; 0 to avoid numerical instabilities
seed &lt;- 5 # any integer, for reproducibility (set NA for no seed)

# ------------------------
# Simulation of a data set
# ------------------------

# Data simulation
sim &lt;- simulate_data_LSODA(
    model = model,
    noise = noise,
    seed = seed,
    steps = steps,
    max_time = max_time,
    lambda = lambda, gamma = gamma, eta = eta,
    pop = pop, 
    beta = beta,
    xstart = xstart)

# Get simulated data sets
obs &lt;- sim$obs
df_beta &lt;- sim$df_beta
if (noise &gt; 0) {
  obs_with_noise &lt;- sim$obs_with_noise
}

# Visualization
plots &lt;- plotting_simulated_data_lsoda(
  model = model,
  sim = sim,
  latency_rate = lambda,
  recovery_rate = gamma,
  fatality_rate = eta,
  log = TRUE)

(simulated_compartments &lt;- plots$simulated_compartments)</code></pre>
<p><img src="workflow_LSODA_files/figure-html/unnamed-chunk-2-1.png" width="768" /></p>
<pre class="r"><code>(simulated_beta &lt;- plots$simulated_beta)</code></pre>
<p><img src="workflow_LSODA_files/figure-html/unnamed-chunk-2-2.png" width="768" /></p>
</div>
<div id="perform-inference" class="section level4">
<h4>Perform inference</h4>
<pre class="r"><code>l &lt;- 9 # lengthscale
noise_wiener_X &lt;- 50 # noise of the Wiener process associated with X
noise_wiener_U &lt;- 0.01 # noise of the Wiener process associated with U
beta0 = df_beta$beta[1] # starting contact rate
beta0prime &lt;- 0 # starting 1st derivative of contact rate
obs_to_use &lt;- obs_with_noise # choose if obs or obs_with_noise

# Initialize
initial_params &lt;-
    initialization(model = model, obs = obs_to_use,
                   beta0 = beta0, beta0prime = beta0prime,
                   lambda = lambda, gamma = gamma, eta = eta,
                   l = l, scale = 1, noise_obs = noise,
                   noise_X = sqrt(noise), noise_U = 0.01,
                   noise_wiener_X = noise_wiener_X, 
                   noise_wiener_U = noise_wiener_U,
                   pop = pop)

# Generate time grids for inference
grids &lt;- generate_grid(obs, num_points_between = 0)

# Run inference
inference_results &lt;- inference(model = model, 
                               grids = grids, 
                               obs = obs, 
                               jit = TRUE,
                               initial_params = initial_params)

# Process data for scoring and visualization
processed_data &lt;- process_data(inference_results,grids)
U_plot &lt;- processed_data$U_plot
X_plot &lt;- processed_data$X_plot

# Compute and display scores
(styled_table &lt;- 
    compute_scores_and_table(U_plot = U_plot, df_beta = df_beta))</code></pre>
<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Scoring Methods Results
</caption>
<thead>
<tr>
<th style="text-align:center;">
Method
</th>
<th style="text-align:center;">
Value
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
Mean Squared Prediction Error
</td>
<td style="text-align:center;">
0.0034514
</td>
</tr>
<tr>
<td style="text-align:center;">
Mean Negative Log Predictive Density
</td>
<td style="text-align:center;">
1.3815411
</td>
</tr>
<tr>
<td style="text-align:center;">
Mean Continuous Ranked Probability Score
</td>
<td style="text-align:center;">
0.3717699
</td>
</tr>
</tbody>
</table>
<pre class="r"><code># Plot compartment counts inferred from simulated data
(compartments &lt;- 
  plot_compartments(model = model,
     obs = obs, 
     obs_with_noise = obs_with_noise, # if available, otherwise set NULL
     X_plot = X_plot))</code></pre>
<p><img src="workflow_LSODA_files/figure-html/unnamed-chunk-3-1.png" width="768" /></p>
<pre class="r"><code># Plot compartment counts separately
plots_sep &lt;- 
  plot_compartments_separately(
    model = model,
    obs = obs,
    obs_with_noise = NULL, # if available, otherwise set NULL
    X_plot = X_plot)

num_plots &lt;- length(plots_sep)
invisible(grid_plots_sep &lt;- grid.arrange(
    grobs = plots_sep,
    ncol = 2,
    nrow = ceiling(num_plots/2)))</code></pre>
<p><img src="workflow_LSODA_files/figure-html/unnamed-chunk-3-2.png" width="768" /></p>
<pre class="r"><code># Plot contact rate with 95% confidence interval
(contact_rate_with_CI &lt;- plot_contact_rate_with_CI(U_plot = U_plot, 
                          df_beta = df_beta, # if available, otherwise set NULL
                          latency_rate = lambda, 
                          recovery_rate = gamma, 
                          fatality_rate = eta, 
                          lengthscale = l))</code></pre>
<p><img src="workflow_LSODA_files/figure-html/unnamed-chunk-3-3.png" width="768" /></p>
</div>
</div>
<div id="simulation-b" class="section level2">
<h2>Simulation B</h2>
<p>Same data set as simulation A, parameters given by random search.</p>
<div id="perform-inference-1" class="section level4">
<h4>Perform inference</h4>
<pre class="r"><code>l &lt;- 6.15 # lengthscale
noise_wiener_X &lt;- 20 # noise of the Wiener process associated with X
noise_wiener_U &lt;- 0.055 # noise of the Wiener process associated with U
beta0 = df_beta$beta[1] # starting contact rate
beta0prime &lt;- 0 # starting 1st derivative of contact rate
obs_to_use &lt;- obs_with_noise # choose if obs or obs_with_noise

# Initialize
initial_params &lt;-
    initialization(model = model, obs = obs_to_use,
                   beta0 = beta0, beta0prime = beta0prime,
                   lambda = lambda, gamma = gamma, eta = eta,
                   l = l, scale = 1, noise_obs = noise,
                   noise_X = sqrt(noise), noise_U = 0.01,
                   noise_wiener_X = noise_wiener_X, 
                   noise_wiener_U = noise_wiener_U,
                   pop = pop)

# Generate time grids for inference
grids &lt;- generate_grid(obs, num_points_between = 0)

# Run inference
inference_results &lt;- inference(model = model, 
                               grids = grids, 
                               obs = obs, 
                               jit = TRUE,
                               initial_params = initial_params)

# Process data for scoring and visualization
processed_data &lt;- process_data(inference_results,grids)
U_plot &lt;- processed_data$U_plot
X_plot &lt;- processed_data$X_plot

# Compute and display scores
(styled_table &lt;- 
    compute_scores_and_table(U_plot = U_plot, df_beta = df_beta))</code></pre>
<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Scoring Methods Results
</caption>
<thead>
<tr>
<th style="text-align:center;">
Method
</th>
<th style="text-align:center;">
Value
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
Mean Squared Prediction Error
</td>
<td style="text-align:center;">
0.0026770
</td>
</tr>
<tr>
<td style="text-align:center;">
Mean Negative Log Predictive Density
</td>
<td style="text-align:center;">
1.3813789
</td>
</tr>
<tr>
<td style="text-align:center;">
Mean Continuous Ranked Probability Score
</td>
<td style="text-align:center;">
0.3715729
</td>
</tr>
</tbody>
</table>
<pre class="r"><code># Plot compartment counts inferred from simulated data
(compartments &lt;- 
  plot_compartments(model = model,
     obs = obs, 
     obs_with_noise = obs_with_noise, # if available, otherwise set NULL
     X_plot = X_plot))</code></pre>
<p><img src="workflow_LSODA_files/figure-html/unnamed-chunk-4-1.png" width="768" /></p>
<pre class="r"><code># Plot compartment counts separately
plots_sep &lt;- plot_compartments_separately(model = model,
                                          obs = obs,
                                          obs_with_noise = NULL, # if available, otherwise set NULL
                                          X_plot = X_plot)

num_plots &lt;- length(plots_sep)
invisible(grid_plots_sep &lt;- grid.arrange(
    grobs = plots_sep,
    ncol = 2,
    nrow = ceiling(num_plots/2)))</code></pre>
<p><img src="workflow_LSODA_files/figure-html/unnamed-chunk-4-2.png" width="768" /></p>
<pre class="r"><code># Plot contact rate with 95% confidence interval
(contact_rate_with_CI &lt;- plot_contact_rate_with_CI(U_plot = U_plot, 
                          df_beta = df_beta, # if available, otherwise set NULL
                          latency_rate = lambda, 
                          recovery_rate = gamma, 
                          fatality_rate = eta, 
                          lengthscale = l))</code></pre>
<p><img src="workflow_LSODA_files/figure-html/unnamed-chunk-4-3.png" width="768" /></p>
</div>
</div>
<div id="simulation-x" class="section level2">
<h2>Simulation X</h2>
<p>More days</p>
</div>
<div id="random-search" class="section level2">
<h2>Random search</h2>
<div id="perform-random-search" class="section level4">
<h4>Perform random search</h4>
<pre class="r"><code># If wished, a random search on a set of parameters can be performed

if (TRUE) { # set TRUE to perform random search
  seed &lt;- 5
  num_param_sets &lt;- 1000 # Number of parameter sets to sample.
  seq_l &lt;- seq(6, 9, by = 0.05)
  seq_wiener_X &lt;- seq(20, 1000, by = 25)
  seq_wiener_U &lt;- seq(0.005, 1, by = 0.005)
  seq_beta0prime &lt;- c(-0.5, 0, 0.5)
  
  results_summary &lt;- 
    run_random_search(
      model = model, obs_to_use = obs_to_use, df_beta = df_beta, 
      noise = noise, lambda = lambda, gamma = gamma, eta = eta, pop = pop, 
      beta0 = beta0, jit = TRUE,
      seed = seed, num_param_sets = num_param_sets, 
      seq_l = seq_l, 
      seq_wiener_X = seq_wiener_X, 
      seq_wiener_U = seq_wiener_U, 
      seq_beta0prime = seq_beta0prime
    )

  plots_scores &lt;- plot_scores(results_summary)
  all_plots &lt;- c(plots_scores$mean_plots, plots_scores$median_plots)
  invisible(grid_of_plots &lt;- grid.arrange(
    grobs = all_plots,
    ncol = 2, 
    nrow = 4))
  
  # If desired, save the plot using ggsave
  # output_dir &lt;- &#39;~/Documents/GitHub/proboder/Results/2024-07-05_16-30-05-sim-A/&#39;
  # ggsave(filename = file.path(output_dir, &#39;grid_search.png&#39;), 
  #        plot = grid_of_plots,
  #        bg = &quot;white&quot;,
  #        width = 8,
  #        height = 6)
  
  (best_params &lt;- find_best_hyperparameters(results_summary))
}</code></pre>
<pre><code>## Duration of the whole workflow: 66.268 sec elapsed</code></pre>
<pre><code>## Warning: `aes_string()` was deprecated in ggplot2 3.0.0.
## ℹ Please use tidy evaluation idioms with `aes()`.
## ℹ See also `vignette(&quot;ggplot2-in-packages&quot;)` for more information.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was
## generated.</code></pre>
<p><img src="workflow_LSODA_files/figure-html/unnamed-chunk-5-1.png" width="768" /></p>
<pre><code>##      l noise_wiener_X noise_wiener_U beta0prime    mean_SPE  median_SPE
## 1 6.15             20          0.055          0 0.002743671 0.000535473
##   mean_NLPD median_NLPD mean_CRPS median_CRPS
## 1  1.381332    1.378062 0.3715678   0.3699697</code></pre>
</div>
</div>
<div id="store-data" class="section level2">
<h2>Store data</h2>
<pre class="r"><code># If wished, the processed data can be stored
directory_save &lt;- &#39;~/Documents/GitHub/proboder/Results/&#39;
if (FALSE) { # Set TRUE to save
  save_processed_data(inference_results = inference_results, 
                      processed_data = processed_data, 
                      directory = directory_save,
                      simulated_compartments = simulated_compartments, 
                      simulated_beta = simulated_beta,
                      compartments = compartments,
                      contact_rate_with_CI = contact_rate_with_CI,
                      grid_plots_sep = grid_plots_sep,
                      styled_table = styled_table)
}

# To store the table as a png file, use the manual export option from the viewer.
# Save in size 400x200.</code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
